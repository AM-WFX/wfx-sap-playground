// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/renderer/History","sap/base/Log","sap/base/util/extend","sap/m/InstanceManager","sap/ui/core/Component","sap/ui/core/Element","sap/ui/core/EventBus","sap/ui/core/library","sap/ui/core/mvc/Controller","sap/ui/core/routing/HashChanger","sap/ui/core/routing/History","sap/ui/Device","sap/ui/performance/trace/Interaction","sap/ui/thirdparty/hasher","sap/ui/thirdparty/jquery","sap/ushell/appIntegration/AppLifeCycle","sap/ushell/appIntegration/PostMessageManager","sap/ushell/ApplicationType/UrlPostProcessing","sap/ushell/bootstrap/SchedulingAgent","sap/ushell/components/SharedComponentUtils","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/library","sap/ushell/performance/FesrEnhancer","sap/ushell/renderer/LogonFrameProvider","sap/ushell/resources","sap/ushell/services/AppConfiguration","sap/ushell/utils","sap/ushell/utils/UrlParsing","sap/ushell/utils/WindowUtils","sap/ushell/renderer/ShellLayout","sap/ushell/Container","sap/ushell/state/modules/BackNavigation","sap/ushell/state/ShellModel","sap/ushell/state/StateManager","sap/ushell/renderers/fiori2/LogonFrameProvider","sap/ushell/renderers/fiori2/History","sap/ushell/renderer/RendererManagedComponents","sap/ushell/ui5service/ShellUIServiceFactory","sap/ushell/navigation/NavigationState","sap/ushell/utils/SmartBusiness"],(e,t,n,i,a,s,o,r,l,c,h,g,d,p,jQuery,u,f,y,v,m,S,w,b,C,_,I,A,N,H,E,T,P,M,F,D,R,x,L,k,U,B)=>{"use strict";const O=L.ComponentCategory;const W=T.ShellArea;const $=r.routing.HistoryDirection;const V=b.AppType;const z=D.LaunchpadState;const j=D.Operation;const q=D.ShellMode;const{Standalone:K,Embedded:G,Minimal:Q}=q;let X=true;let Y=false;const J={embedded:0,newWindowThenEmbedded:1,newWindow:1,replace:0};const Z={embedded:"embedded",newWindowThenEmbedded:"newWindowThenEmbedded",newWindow:"newWindow",replace:"replace"};let ee={};C.init();const te="Shell.controller";const ne="[FesrFlp]";return l.extend("sap.ushell.renderer.Shell",{_aDoables:[],addDoable:function(e){this._aDoables.push(e)},_aDanglingControls:[],addDanglingControl:function(e){this._aDanglingControls.push(e)},_aDanglingBindings:[],addDanglingBinding:function(e){this._aDanglingBindings.push(e)},removeDanglingBinding:function(e){const t=this._aDanglingBindings.findIndex(t=>t===e);if(t>-1){this._aDanglingBindings.splice(t,1)}},_aPendingInitializations:[],addPendingInitialization:function(e){this._aPendingInitializations.push(e);return e},awaitPendingInitializations:function(){const e=this._aPendingInitializations.length;return Promise.allSettled(this._aPendingInitializations).then(()=>{const t=this._aPendingInitializations.length;if(e<t){return this.awaitPendingInitializations()}})},onComponentTargetDisplay:function(e){const t=e.getParameters();const n=t.control;const i=t.object;if(this.bRestorePreviousHash){this.bRestorePreviousHash=false}n.navTo(i.getId())},onInit:function(){const t=a.getOwnerComponentFor(this.getView())?.getRouter();t.getTarget("home").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("appfinder").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("contentfinder").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("pages").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("workpages").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("runtimeSwitcher").attachDisplay(this.onComponentTargetDisplay,this);t.getTarget("wzsearch").attachDisplay(this.onComponentTargetDisplay,this);if(S.last("/core/homeApp/enabled")){t.getTarget("homeapp").attachDisplay(this.onComponentTargetDisplay,this)}t.oHashChanger=c.getInstance();t.initialize(true);this.bEnableHashChange=true;X=true;const n=this.getView();const i=n.getViewData()||{};const r=window.matchMedia("(min-width: 600px)");const l=i.config||{};n.setModel(this._getConfigModel(),"configModel");n.setModel(F.getModel(),"shellModel");this._bindTabTitle();this._bindContentDensity();S.emit("/core/shell/model/personalization",S.last("/core/shell/enablePersonalization"));function h(e){S.emit("/core/shell/model/isPhoneWidth",!e.matches)}if(r.addListener){r.addListener(h);h(r)}n.setModel(I.i18nModel,"i18n");o.getInstance().subscribe("externalSearch",this.externalSearchTriggered,this);o.getInstance().subscribe("sap.ushell","appOpened",this.onAppOpened,this);o.getInstance().subscribe("ESHSearchFinished",this._logSearchActivity,this);this._setConfigurationToModel();this._registerAndCreateEventHubDoables();k.attachBackNavigationChanged(this._onBackNavigationChanged,this);this.history=e;this.oNavContainer=s.getElementById("viewPortContainer");u.init(this.oNavContainer,l.disableHomeAppCache);Promise.all([P.getServiceAsync("ShellNavigationInternal"),P.getServiceAsync("AppLifeCycle")]).then(e=>{const n=e[0];this._oAppLifeCycleService=e[1];this._oAppLifeCycleService.init(this.oNavContainer);this._initShellNavigationInternal(n,this._oAppLifeCycleService,t)});P.setLogonFrameProvider(this._getLogonFrameProvider());if(g.system.desktop){sap.ui.require(["sap/ushell/renderer/AccessKeysHandler"],e=>{e.init()})}window.onbeforeunload=function(){if(P&&P.getDirtyFlag()&&!(g.browser.name===g.browser.BROWSER.INTERNET_EXPLORER&&u.getCurrentApplication().container.getApplicationType()==="NWBC")){return I.i18n.getText("dataLossExternalMessage")}return};if(ee.enableOnlineStatus){sap.ui.require(["sap/ushell/ui5service/UserStatus"],e=>{this.oUserStatus=new e({scopeObject:this.getOwnerComponent(),scopeType:"component"})})}if(!l.disableSignOut&&(l.sessionTimeoutTileStopRefreshIntervalInMinutes>0||l.sessionTimeoutReminderInMinutes>0)){this._createSessionHandler(l)}if(g.system.desktop){sap.ui.require(["sap/ushell/renderer/AccessKeysHandler"],e=>{n.waitForShellLayout().then(()=>{const t=document.getElementById(W.NavigationBar);t.addEventListener("focusin",()=>{e.bFocusOnShell=false;e.bFocusPassedToExternalHandlerFirstTime=false});t.addEventListener("focusout",()=>{e.bFocusOnShell=true;e.bFocusPassedToExternalHandlerFirstTime=true});const n=document.getElementById(W.RendererRootView);n.addEventListener("focusin",()=>{e.bFocusOnShell=false;e.bFocusPassedToExternalHandlerFirstTime=false});n.addEventListener("focusout",()=>{e.bFocusOnShell=true;e.bFocusPassedToExternalHandlerFirstTime=true})})})}},_initShellNavigationInternal:function(e,t,n){this.oShellNavigationInternal=e;this.oShellNavigationInternal.registerPrivateFilters(t);this.oShellNavigationInternal.registerExtraRouter(n);this.oShellNavigationInternal.registerNavigationFilter(this._handleEmptyHash.bind(this));const i=this._handleSmartBusiness.bind(this);this.oShellNavigationInternal.registerNavigationFilter(i);this.oShellNavigationInternal.init(this.doHashChange.bind(this));this.oShellNavigationInternal.unregisterNavigationFilter(i);this.oShellNavigationInternal.registerNavigationFilter(this._disableSourceAppRouter.bind(this));this.oShellNavigationInternal.registerNavigationFilter(this.handleDataLoss.bind(this));this.oShellNavigationInternal.registerNavigationFilter(this._unblockUI.bind(this));this.oShellNavigationInternal.registerNavigationFilter(i);u.registerHandleHashChange(this.oShellNavigationInternal);w.emit("ShellNavigationInitialized",Date.now())},_bindContentDensity:function(){const e=F.getModel().bindProperty("/application/contentDensity");function t(){const t=e.getValue();const n=t==="compact";document.body.classList.toggle("sapUiSizeCompact",n);document.body.classList.toggle("sapUiSizeCozy",!n)}t.call(this);e.attachChange(t);this._aDanglingBindings.push(e)},_bindTabTitle:function(){const e=F.getModel().bindProperty("/application/title");const t=F.getModel().bindProperty("/application/titleAdditionalInformation");function n(){const e=this._calculateWindowTitle();if(e){A.setWindowTitle(e)}}n.call(this);e.attachChange(n.bind(this));t.attachChange(n.bind(this));this._aDanglingBindings.push(e);this._aDanglingBindings.push(t)},_calculateWindowTitle:function(){let e="";const t=F.getModel().getProperty("/application/title")||"";const n=F.getModel().getProperty("/application/titleAdditionalInformation");if(n?.searchTerm){if(n.searchScope){e=I.i18n.getText("titleWindowSearchTermWithScope",[n.searchTerm,n.searchScope])}else{e=I.i18n.getText("titleWindowSearchTerm",[n.searchTerm])}}else if(n?.headerText&&n?.additionalContext){e=I.i18n.getText("titleWindow",[n.headerText,n.additionalContext])}else{e=n?.headerText||n?.additionalContext||t}return e},_getConfigModel:function(){return F.getConfigModel()},getNavContainer:function(){return s.getElementById("viewPortContainer")},_registerAndCreateEventHubDoables:function(){[w.once("CenterViewPointContentRendered").do(this._loadCoreExt.bind(this)),w.once("PagesRuntimeRendered").do(this._loadCoreExt.bind(this)),w.once("AppRendered").do(this._loadCoreExtNonUI5.bind(this)),w.once("CoreResourcesComplementLoaded").do(this._onCoreResourcesComplementLoaded.bind(this)),w.once("loadRendererExtensions").do(this._loadRendererExtensionPlugins.bind(this)),w.once("loadWarmupPlugins").do(this._loadWarmupPlugins.bind(this)),w.once("loadTrackingActivitiesSetting").do(this._loadTrackingActivitiesSetting.bind(this)),w.once("initMessagePopover").do(this._initializeMessagePopover.bind(this))].forEach(e=>{this.addDoable(e)});this.addDoable(w.on("toggleContentDensity").do(this.toggleContentDensity.bind(this)))},_onBackNavigationChanged:async function(e){const t=e.getParameters().data;const n=D.getShellMode();const i=D.getLaunchpadState();if(t){M.setNavigateBack(t);if(i===z.App&&[Q,K,G].includes(n)){P.getRendererInternal("fiori2").showHeaderItem("backBtn",true)}}else{M.resetNavigateBack()}},toggleContentDensity:function(e){const t=e.contentDensity==="compact";return f.sendRequestToAllApplications("sap.ushell.appRuntime.uiDensityChange",{isTouch:t?"0":"1"},false)},_handleEmptyHash:function(e){e=typeof e==="string"?e:"";e=e.split("?")[0];if(e.length===0){const e=this.getView()?this.getView().getViewData():{};ee=e.config||{};if(ee.migrationConfig){return this.oShellNavigationInternal.NavigationFilterStatus.Continue}if(ee.rootIntent){window.setTimeout(()=>{p.setHash(ee.rootIntent)},0);return this.oShellNavigationInternal.NavigationFilterStatus.Abandon}}return this.oShellNavigationInternal.NavigationFilterStatus.Continue},_handleSmartBusiness:function(e){if(!e.includes("sap-ssb-eval-id")){return this.oShellNavigationInternal.NavigationFilterStatus.Continue}this.bSkipNextDataLossCheck=true;(async()=>{let t=H.parseShellHash(e);try{const e=await P.getServiceAsync("Navigation");t=await B.resolveEvaluationId(t);const n={target:{semanticObject:t.semanticObject,action:t.action,contextRaw:t.contextRaw},params:t.params,appSpecificRoute:t.appSpecificRoute,writeHistory:false};e.navigate(n)}catch(n){this.bSkipNextDataLossCheck=false;if(window["sap-ushell-async-libs-promise-directstart"]){delete window["sap-ushell-async-libs-promise-directstart"]}const i=t.params["sap-ssb-eval-id"]&&t.params["sap-ssb-eval-id"][0];const a=`Failed to execute Smart Business navigation for evaluation ID ${i}`;U.endNavigation();const s=!Y;this.hashChangeFailure(this.history.getHistoryLength(),{title:I.i18n.getText("error"),message:I.i18n.getText("failed_to_open_app_missing_configuration_or_role_assignment"),technicalMessage:a},{info:I.i18n.getText("cannot_resolve_navigation_target_details",[e]),technicalMessage:n},"sap.ushell.renderer.Shell.controller",s)}})();return this.oShellNavigationInternal.NavigationFilterStatus.Custom},_unblockUI:function(){s.getElementById("shell-header")?.setBlocked?.(false);s.getElementById("menubar")?.setBlocked?.(false);return this.oShellNavigationInternal.NavigationFilterStatus.Continue},_notifyAsyncStep:function(){return d.notifyAsyncStep()},_setConfigurationToModel:function(){const e=this.getView().getViewData();if(e){ee=e.config||{}}if(ee){if(ee.states){t.error("The 'states' configuration was discontinued")}if(ee.enableSetTheme!==undefined){this._getConfigModel().setProperty("/setTheme",ee.enableSetTheme)}this._getConfigModel().setProperty("/contentDensity",ee.enableContentDensity===undefined?true:ee.enableContentDensity);if(ee.migrationConfig!==undefined){this._getConfigModel().setProperty("/migrationConfig",ee.migrationConfig)}if(ee.enableUserDefaultParameters!==undefined){this._getConfigModel().setProperty("/userDefaultParameters",ee.enableUserDefaultParameters)}if(ee.disableHomeAppCache!==undefined){this._getConfigModel().setProperty("/disableHomeAppCache",ee.disableHomeAppCache)}this._getConfigModel().setProperty("/enableHelp",S.last("/core/extension/enableHelp"));this._getConfigModel().setProperty("/searchAvailable",ee.enableSearch!==false);if(ee.title!==undefined){this.setHeaderTitle(ee.title)}}},_loadTrackingActivitiesSetting:async function(e){try{let t=await this._getPersData({container:"flp.settings.FlpSettings",item:"userActivitesTracking"});if(t===undefined){t=true}this._getConfigModel().setProperty("/enableTrackingActivity",t);w.emit("StepDone",e.stepName)}catch(n){t.error("Failed to load tracking activities state from the personalization, tracking activities is disabled",n,"sap.ushell.components.flp.settings.FlpSettings");this._getConfigModel().setProperty("/enableTrackingActivity",false);w.emit("StepDone",e.stepName)}},_getPreviousPageDirty:function(){return Y},_setPreviousPageDirty:function(e){Y=e},getModelConfiguration:function(){const e=this.getView().getViewData();let t;if(e){const i=e.config||{};t=n({},i)}delete t.applications;return t},_getLogonFrameProvider:function(){return _},onExit:function(){X=true;this._aDoables.forEach(e=>{e.off()});this._aDoables=[];k.detachBackNavigationChanged(this._onBackNavigationChanged,this);this._aDanglingControls.forEach(e=>{e.destroy()});this._aDanglingControls=[];this._aDanglingBindings.forEach(e=>{e.destroy()});this._aDanglingBindings=[];o.getInstance().unsubscribe("externalSearch",this.externalSearchTriggered,this);o.getInstance().unsubscribe("ESHSearchFinished",this._logSearchActivity,this);o.getInstance().unsubscribe("sap.ushell","appOpened",this.onAppOpened,this);if(this.oShellNavigationInternal&&this.oShellNavigationInternal.hashChanger){this.oShellNavigationInternal.hashChanger.destroy()}sap.ui.require("sap/ushell/UserActivityLog")?.deactivate();D.destroy(true);u.reset?.()},_getCurrentAppRouter:function(){const e=this._oAppLifeCycleService;const t=e&&e.getCurrentApplication&&e.getCurrentApplication();const n=t&&t.componentInstance;if(n){return n.getRouter()}return null},_disableSourceAppRouter:function(e,t){if(!this.bEnableHashChange||this.bRestorePreviousHash){return this.oShellNavigationInternal.NavigationFilterStatus.Continue}const n=this.oShellNavigationInternal.hashChanger.isInnerAppNavigation(e,t);if(!n){const e=this._getCurrentAppRouter();if(e&&e.isInitialized()){e.stop()}}return this.oShellNavigationInternal.NavigationFilterStatus.Continue},_resumeAppRouterIgnoringCurrentHash:function(){const e=this._getCurrentAppRouter();if(e){e.initialize(true)}},handleDataLoss:function(e,t){if(this.bSkipNextDataLossCheck){this.bSkipNextDataLossCheck=false;return this.oShellNavigationInternal.NavigationFilterStatus.Continue}const n=this.oShellNavigationInternal.hashChanger;const i=n.getReloadApplication();if(this.bReloadApplication!==null&&this.bReloadApplication!==undefined){n.setReloadApplication(this.bReloadApplication);this.bReloadApplication=null}if(t===""||p.disableBlueBoxHashChangeTrigger===true){return this.oShellNavigationInternal.NavigationFilterStatus.Continue}if(!this.bEnableHashChange&&!this.bRedoNavigation){this.bEnableHashChange=true;return this.oShellNavigationInternal.NavigationFilterStatus.Custom}if(this.bRestorePreviousHash){return this.oShellNavigationInternal.NavigationFilterStatus.Continue}if(this.bRedoNavigation){this.bRedoNavigation=false;this.bEnableHashChange=true;this.bExplaceNavigation=false;return this.oShellNavigationInternal.NavigationFilterStatus.Continue}const a=H.parseShellHash(e);const s=P.getRendererInternal()._isBuiltInIntent(a);const o=a.params["sap-ushell-navmode"];const r=o&&o[0];if(!s&&(this.bExplaceNavigation||r==="explace"||r==="frameless")){this.bExplaceNavigation=false;return this.oShellNavigationInternal.NavigationFilterStatus.Continue}const l=P.getDirtyFlag();const c=P.isAsyncDirtyStateProviderSet();if(!c&&!l){Y=l;return this.oShellNavigationInternal.NavigationFilterStatus.Continue}const g=h.getInstance().getHistoryStateOffset()<0;this._oLastDataLossPromise=Promise.all([this._waitForHash(t),P.getServiceAsync("NavTargetResolutionInternal"),P.getDirtyFlagsAsync()]).then(async t=>{const n=t[1];const a=t[2];Y=a;if(!a){this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo");return}if(s){if(this._handleDirtyStateUserConfirm()){this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo")}return}const o=`#${e}`;try{const t=await n.resolveHashFragment(o);const a=t.targetNavigationMode==="explace"||t.targetNavigationMode==="frameless";const s=g&&t.navigationMode===Z.newWindowThenEmbedded;if(a&&!s){this.bExplaceNavigation=true;this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo")}else if(this._handleDirtyStateUserConfirm()){this.bRedoNavigation=true;this.bReloadApplication=i;this._restoreHashUsingAction(e,"redo")}}catch{this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo")}});return this._restoreHashUsingAction(t,"undo")},_waitForHash:function(e){const t=`#${e}`;return new Promise(e=>{function n(){const i=t===decodeURIComponent(window.location.hash);if(i){window.removeEventListener("hashchange",n);e()}}window.addEventListener("hashchange",n)})},_handleDirtyStateUserConfirm:function(){t.debug(`${ne} Interaction Start`,"_handleDirtyStateUserConfirm",te);const e=this._notifyAsyncStep();if(window.confirm(I.i18n.getText("dataLossInternalMessage"))){P.setDirtyFlag(false);t.debug(`${ne} Interaction End`,"_handleDirtyStateUserConfirm",te);e();Y=true;return true}t.debug(`${ne} Interaction End`,"_handleDirtyStateUserConfirm",te);e();return false},_restoreHashUsingAction:function(e,t){const n=this.oShellNavigationInternal.wasHistoryEntryReplaced();const i=this._getRestoreHashStrategy(n,t);this._resumeAppRouterIgnoringCurrentHash();return this._restoreHash(i,e)},_getRestoreHashStrategy:function(e,t){if(e){return{strategy:"replaceHash",stepCount:0}}let n;let i=h.getInstance().getHistoryStateOffset();if(i===undefined||i>=0){i=1}else if(i<0){i=-1}if(t==="undo"){if(i<0){n="historyForward"}else{n="historyBack"}this.sLastUndoStrategy=n}else{switch(this.sLastUndoStrategy){case"historyBack":n="historyForward";break;case"historyForward":n="historyBack";break;default:n="replaceHash"}}return{strategy:n,stepCount:1}},_restoreHash:function(e,t){const n={status:this.oShellNavigationInternal.NavigationFilterStatus.Custom,hash:""};switch(e.strategy){case"historyBack":this.bEnableHashChange=false;this._windowHistoryBack(e.stepCount);break;case"historyForward":this.bEnableHashChange=false;this._windowHistoryForward(e.stepCount);break;case"replaceHash":this.bEnableHashChange=false;p.replaceHash(t);break;default:throw new Error("Cannot execute unknown navigation strategy")}return n},_setEnableHashChange:function(e){this.bEnableHashChange=e},_logRecentActivity:async function(e){if(!this.oInitialEnableTrackingPromise){if(S.last("/core/shell/model/enableTrackingActivity")!==undefined){this.oInitialEnableTrackingPromise=Promise.resolve()}else{this.oInitialEnableTrackingPromise=new Promise(e=>{S.once("/core/shell/model/enableTrackingActivity").do(e)})}}await this.oInitialEnableTrackingPromise;if(S.last("/core/shell/model/enableTrackingActivity")){const t=await P.getServiceAsync("UserRecents");return t.addActivity(e)}t.warning("Tracking is not enabled",null,"sap.ushell.renderer.Shell.controller");throw new Error("Tracking is not enabled")},doHashChange:function(e,n,i,a,s){t.debug(`${ne} Interaction Start`,"doHashChange",te);N.setPerformanceMark("FLP-ShellController-doHashChange-begin");m.toggleUserActivityLog();w.emit("trackHashChange",e);const o=new jQuery.Deferred;this._bWasHistoryEntryReplaced=this.oShellNavigationInternal.wasHistoryEntryReplaced();this.oShellNavigationInternal.resetHistoryEntryReplaced();if(!this.bEnableHashChange){this.bEnableHashChange=true;o.resolve();U.endNavigation();return o.promise()}if(this.bRestorePreviousHash){this.bRestorePreviousHash=false;o.resolve();U.endNavigation();return o.promise()}const r=`${e}${n??""}`;const l=H.parseShellHash(r,true);const c=`${i}${a??""}`;const h=H.parseShellHash(c,true);if(s){t.error(`Error when parsing the hash: '${r}'`,s);this.hashChangeFailure(this.history.getHistoryLength(),s.message,null,"sap.ushell.renderer.Shell.controller",false).then(o.resolve.bind(o)).catch(o.reject.bind(o));U.endNavigation();return o.promise()}const g=this._notifyAsyncStep();this._doHashChange(l,h).catch(()=>{w.emit("doHashChangeError",Date.now())}).finally(()=>{t.debug(`${ne} Interaction End`,"doHashChange",te);g();U.endNavigation();o.resolve()});return o.promise()},_doHashChange:async function(e,n){const i=this.history.getHistoryLength();const a=H.constructShellHash({...e,appSpecificRoute:undefined},true);const s=H.constructShellHash({...n,appSpecificRoute:undefined},true);this.history.hashChange(a,s);const o=A.getCurrentApplication();try{const a=await this._resolveHashFragment(e);if(!a&&window.QUnit!==undefined){return}if(a.navigationMode===null){if(N.isColdStart()){p.setHash("");return}this.bEnableHashChange=false;this.history.pop();this._windowHistoryBack(1);return}await u.storeAppExtensions();D.stallChanges();const s=await this._openAppViaNWBC(a,o);if(s===true){this.logOpenAppAction(a,e).catch(()=>{t.info("NWBC application was not logged.",undefined,"sap.ushell.renderer.Shell.controller")});D.applyStalledChanges();return}if(a.navigationMode===Z.newWindow){this.logOpenAppAction(a,e).catch(()=>{t.info("Application in new window was not logged.",undefined,"sap.ushell.renderer.Shell.controller")});await this._openAppExplace(a,o);D.applyStalledChanges();return}const r=this._rewriteRootIntentForMigrationConfig(a,e);if(r){D.applyStalledChanges();return}try{const s=this.oShellNavigationInternal.isInitialNavigation();try{await this._openAppInplace(e,a,n,o)}catch(n){const o=H.constructShellHash(e,true);t.error(`Application initialization for intent "${o}" failed.`,n);const r=A.getMetadata(a,e);this.oShellNavigationInternal.setIsInitialNavigation(s);await this.hashChangeFailure(i,n.name,n.message,r?r.title:"",false)}}catch(n){const a=H.constructShellHash(e,true);t.error("Failed to open application",n,"sap.ushell.renderer.Shell.controller");const s=I.i18n.getText("cannot_load_ui5_component_details",[a]);const r=`Failed to load UI5 component for navigation intent "${a}"`;A.setCurrentApplication(o);await this.hashChangeFailure(i,{title:I.i18n.getText("error"),message:I.i18n.getText("failed_to_open_ui5_component"),technicalMessage:r},{info:s,technicalMessage:`${n.message}\n${n.stack}`},"sap.ushell.renderer.Shell.controller",false)}}catch(n){const a=H.constructShellHash(e,true);t.error("Hash change handling failed. Could not open app.",n,"sap.ushell.renderer.Shell.controller");const s=I.i18n.getText("cannot_resolve_navigation_target_details",[a]);const o=`Failed to resolve navigation target "${a}". This is most likely caused by an incorrect SAP Fiori launchpad content configuration or by missing role assignment.`;await this.hashChangeFailure(i,{title:I.i18n.getText("error"),message:I.i18n.getText("failed_to_open_app_missing_configuration_or_role_assignment"),technicalMessage:o},{info:s,fixedShellHash:a,technicalMessage:n.message},"sap.ushell.renderer.Shell.controller",false);throw n}},_rewriteRootIntentForMigrationConfig:function(e,t){if(S.last("/core/shell/model/migrationConfig")){ee.migrationConfig=false;this._getConfigModel().setProperty("/migrationConfig",false);if(H.isEmptyHash(t)){if(e){ee.rootIntent=""}else{window.setTimeout(()=>{p.setHash(ee.rootIntent)},0);return true}}}return false},_openAppExplace:async function(e,t){e.url=await y.processUrl(e.url,e.applicationType,true,undefined);u.publishAppOpeningEvent(e);const n=E.openURL(e.url);if(!n&&!this._checkWindowLocationSearch("workzone-mobile-app=true")){const e=I.i18n.getText("fail_to_start_app_popup_blocker",[window.location.hostname]);this.delayedMessageError(e)}u.publishAppOpenedEvent(e);this._restorePreviousHashAfterOpenNewWindow(e,t)},_closeAllDialogs:function(){if(i&&X){i.closeAllDialogs();i.closeAllPopovers()}X=true},_resolveHashFragment:async function(e){const n=H.constructShellHash(e,true);const i=this._getConfig();let a;if(window["sap-ushell-async-libs-promise-directstart"]){try{const e=await window["sap-ushell-async-libs-promise-directstart"];delete window["sap-ushell-async-libs-promise-directstart"];a=e.resolvedHashFragment}catch(e){delete window["sap-ushell-async-libs-promise-directstart"];throw e}}else{const e=await P.getServiceAsync("NavTargetResolutionInternal");a=await N.promisify(e.resolveHashFragment(n))}if(!a&&window.QUnit!==undefined&&!window._bTestNullNavigationMode){return}if(!a){a={navigationMode:null}}A.setCurrentApplication(a);const s=H.constructBasicHash(e);if(i?.applications?.[s]){a.applicationConfiguration=i.applications[s]}a.sFixedShellHash=n;if(H.isRootIntent(e)){a.navigationMode=Z.embedded}if(a.navigationMode!==null&&!a.navigationMode){t.error("Mandatory member 'navigationMode' is missing in the resolution result! Temporarily set to 'embedded' for further processing...","sap.ushell.renderer.Shell.controller");a.navigationMode=Z.embedded}this._setEffectiveNavigationMode(a);N.setPerformanceMark("FLP-ShellController-resolveHashFragment-end");return a},_setEffectiveNavigationMode:function(e){if(!e){return}const t=e.navigationMode;if(t===Z.newWindowThenEmbedded){if(N.isColdStart()||h.getInstance().getDirection()===$.Backwards){e.navigationMode=Z.embedded}else{e.navigationMode=Z.newWindow;if(!N.isNativeWebGuiNavigation(e)){e.applicationType="URL";e.url=this._getCurrentLocationHash()}}return}if(t===Z.newWindow&&N.isColdStart()){if(this._hasAppCapabilitiesNavigationMode(e)&&e.appCapabilities.navigationMode===Z.embedded){e.navigationMode=Z.embedded;return}e.navigationMode=Z.replace;return}if(t===Z.newWindow&&this._hasAppCapabilitiesNavigationMode(e)&&e.appCapabilities.navigationMode===Z.embedded){e.url=this._getCurrentLocationHash()}},_hasAppCapabilitiesNavigationMode:function(e){return N.isPlainObject(e.appCapabilities)&&e.appCapabilities.hasOwnProperty("navigationMode")},_openAppInplace:async function(e,n,i){if(n.replaceHashBeforeOpenAppInplace){p.replaceHash(n.replaceHashBeforeOpenAppInplace)}this._closeAllDialogs();const a=n.navigationMode;if(a===Z.replace){this.oShellNavigationInternal.setIsInitialNavigation(false);this.bEnableHashChange=false;this._changeWindowLocation(n.url);return}if(a!==Z.embedded){return this.hashChangeFailure(this.history.getHistoryLength(),`Navigation mode '${a}' was not recognized`,null,"sap.ushell.renderer.Shell.controller",false)}n.targetNavigationMode=N.isColdStart()?"explace":"inplace";if(!N.isColdStart()&&!this._bWasHistoryEntryReplaced){this.oShellNavigationInternal.setIsInitialNavigation(false)}u.resetGlobalShellUIService();const s=this._isFLPIntent(i);const o=await u.startApplication(n,e,s);const r=o.getNavigationRedirectHash();if(typeof r==="string"){t.warning(`Performing navigation redirect to hash "${r}"`);this.history.pop();const e=await P.getServiceAsync("ShellNavigationInternal");return e.toExternal({target:{shellHash:r}},undefined,false)}const l=H.isEmptyHash(e)||H.isRootIntent(e);await o.navTo(l);const c=A.getMetadata(n,e);w.emit("CloseFesrRecord",{time:Date.now(),technicalName:c.technicalName});return},_openAppViaNWBC:async function(e,n){const i=e&&(N.isNativeWebGuiNavigation(e)||e.nativeNWBCNavigation);if(!i){return false}const a=N.getPrivateEpcm();const s=J[e.navigationMode];let o;if(N.hasNavigationModeCapability()){o=s||J[Z.embedded]}const r=await this._appendUserIdToUrl("sap-user",e.url);const l=await N.appendSapShellParam(r);const c=e.applicationType;const h=e?.appCapabilities?.appFrameworkId;let g;try{if(N.isSAPLegacyApplicationType(c,h)){const t=Object.create(null);const n=await P.getServiceAsync("Navigation");const i=N.getParamKeys(l);if(i.aAppStateNamesArray.length>0){const e=await n.getAppStateData(i.aAppStateKeysArray);i.aAppStateNamesArray.forEach((n,i)=>{if(e[i]){t[n]=e[i]}})}t["sap-flp-url"]=P.getFLPUrl(true);t["system-alias"]=e.systemAlias;g=[{name:"sap-flp-params",value:JSON.stringify(t)}]}}catch{}try{u.publishAppOpeningEvent(e);if(!a.doNavigate(l,o,undefined,undefined,undefined,undefined,undefined,g)){return false}u.publishAppOpenedEvent(e);await this._restoreAfterNwbcNavigation(e,n);if(this._oAppLifeCycleService.getCurrentApplication()&&this._oAppLifeCycleService.getCurrentApplication().homePage){this._setMenuVisible(true);this._setSideNavigationVisible(true)}return true}catch(n){t.error("Application initialization failed due to an Exception:",n);await this.hashChangeFailure(this.history.getHistoryLength(),n.name,n.message,e.text,false);return false}},_restoreAfterNwbcNavigation:async function(e,t){if(this.history.getHistoryLength()===1&&!this._oAppLifeCycleService.getCurrentApplication()){const e=await P.getServiceAsync("Navigation");e.navigate({target:{shellHash:"#"},writeHistory:false});return}this._restorePreviousHashAfterOpenNewWindow(e,t)},_appendUserIdToUrl:async function(e,t){const n=await P.getServiceAsync("UserInfo");const i=n.getUser().getId();const a=t.indexOf("?")>=0?"&":"?";return`${t+a+e}=${i}`},_restorePreviousHashAfterOpenNewWindow:function(e,t){this.history.pop();const n=e.componentHandle&&e.componentHandle.getInstance&&e.componentHandle.getInstance({});if(n){n.destroy()}this._resumeAppRouterIgnoringCurrentHash();this.bRestorePreviousHash=true;this._windowHistoryBack(1);A.setCurrentApplication(t);w.emit("openedAppInNewWindow",Date.now())},hashChangeFailure:async function(e,t,n,i,a){D.discardStalledChanges();if(N.isPlainObject(t)){this.reportError(t.technicalMessage,n.technicalMessage,i);const e=await P.getServiceAsync("MessageInternal");e.show(e.Type.ERROR,t.message,{title:t.title,details:n})}else{this.reportError(t,n,i);this.delayedMessageError(I.i18n.getText("fail_to_start_app_try_later"))}X=false;this._resumeAppRouterIgnoringCurrentHash();if(e===0){p.setHash("")}else if(new URLSearchParams(window.location.search).get("bFallbackToShellHome")){p.setHash("")}else{this.bEnableHashChange=a;P.setDirtyFlag(Y);this._windowHistoryBack(1)}},reportError:function(e,n,i){t.error(e,n,i)},delayedMessageError:async function(e){try{await N.awaitTimeout(0);const t=await P.getServiceAsync("MessageInternal");t.error(e)}catch{}},_checkWindowLocationSearch:function(e){return window.location.search.indexOf(e)>-1},_windowHistoryBack:function(e){window.history.go(-1*e)},_windowHistoryForward:function(e){window.history.go(e)},_changeWindowLocation:function(e){window.location.href=e},_setMenuVisible:function(e){const t=document.getElementById(W.NavigationBar);if(!t){return}e=e||S.last("/core/menu/enabled")&&S.last("/core/menu/visibleInAllStates");t.classList.toggle("sapUshellShellHidden",!e)},_setSideNavigationVisible:function(e){const t=document.getElementById(W.SideNavigation);if(!t){return}e=e||S.last("/core/sideNavigation/enabled")&&S.last("/core/sideNavigation/mode")==="Docked";t.classList.toggle("sapUshellShellHidden",!e)},onAppOpened:function(e,n,i){if(i.targetNavigationMode!=="explace"&&i.targetNavigationMode!=="frameless"){this._setMenuVisible(false)}this._setSideNavigationVisible(true);const a=i.sFixedShellHash;const s=H.parseShellHash(a);this.logOpenAppAction(i,s).catch(e=>{t.info("Opened application was not logged.",e,"sap.ushell.renderer.Shell.controller")});this._notifyUITracer(i,s)},externalSearchTriggered:function(e,t,n){S.emit("/core/shell/model/searchTerm",n.searchTerm);n.query=n.searchTerm},onBeforeNavigate:function(e){const t=e.getParameter("to");const n=L.isManagedComponentInstance(t,[O.Home]);this._setMenuVisible(n);this._setSideNavigationVisible(n)},onAfterNavigate:function(e){o.getInstance().publish("sap.ushell","navigated",{})},logOpenAppAction:async function(e,t){const n=S.last("/core/shell/enableRecentActivity")&&S.last("/core/shell/enableRecentActivityLogging");if(!n){throw new Error("Tracking of RecentActivity is disabled.")}const i=A.getMetadata(e,t);const a={title:i.title,appType:V.APP,url:H.constructShellHash(t,true)};a.appId=H.constructBasicHash(t,true);const s=["#Action-search","#Shell-startIntent"];if(s.includes(a.appId)){throw new Error("RecentActivity was not logged.")}await N.awaitTimeout(1500);await this._logRecentActivity(a)},_notifyUITracer:function(e,n){try{const t=e.reservedParameters?.["sap-fiori-id"]?.[0]||e.reservedParameters?.["sap-ui-app-id-hint"]?.[0]||e.ui5ComponentName;const i={...n,appSpecificRoute:undefined};const a=H.constructShellHash(i,true);w.emit("UITracer.trace",{reason:"NavigateApp",source:"Intent",data:{applicationId:t||"",applicationType:e.applicationType||"",hash:a,targetNavigationMode:e.targetNavigationMode||"",providerId:e.contentProviderId||"",targetUrl:e.url||""}})}catch(e){t.warning("Could not emit UITracer.trace event",e,"sap.ushell.renderer.Shell.controller")}},_logSearchActivity:function(){if(S.last("/core/shell/enableRecentActivity")&&S.last("/core/shell/enableRecentActivityLogging")){let e="";try{e=s.getElementById("searchFieldInShell-input").getModel().getLastSearchTerm()}catch(e){t.error("Shell: last search term is not available to log a recent activity",e)}this._logRecentActivity({appId:"#Action-search",appType:V.SEARCH,title:e,url:`#${p.getHash()}`}).catch(()=>{t.info("Search activity was not logged.",undefined,"sap.ushell.renderer.Shell.controller")})}},_loadCoreExtNonUI5:function(e){if(e&&e.applicationType!=="SAPUI5"){this._loadCoreExt()}},_onCoreResourcesComplementLoaded:function(){N.setPerformanceMark("SchedulingAgent-StartOfFlow");const e=this.getView();if(e){e.createPostCoreExtControls()}v._initialize();w.emit("startScheduler")},_loadRendererExtensionPlugins:async function(e){const t=new URLSearchParams(window.location.search);const n=t.get("sap-ushell-xx-pluginmode")==="delayed";const i=await P.getServiceAsync("PluginManager");if(n){await N.awaitTimeout(5e3)}i.loadPlugins("RendererExtensions").always(()=>{w.emit("StepDone",e.stepName)})},_loadWarmupPlugins:async function(e){const n=await P.getServiceAsync("PluginManager");n.loadPlugins("AppWarmup").always(()=>{t.debug("WARMUP plugins loaded",null,"sap.ushell.renderer.Shell");w.emit("StepDone",e.stepName);N.setPerformanceMark("SchedulingAgent-EndOfFlow");N.setPerformanceMeasure("SchedulingAgentTotalTime","SchedulingAgent-StartOfFlow","SchedulingAgent-EndOfFlow")})},_loadCoreExt:async function(){await P.getServiceAsync("Ui5ComponentLoader");w.emit("loadCoreResourcesComplement",Date.now())},getRightFloatingContainerVisibility:function(){const e=this.getView().getRightFloatingContainer();return e&&e.getVisible()},setHeaderTitle:function(e){D.updateAllBaseStates("header.secondTitle",j.Set,e||"")},setNavigationBar:function(e){e.placeAt(W.NavigationBar,"only");this.addDanglingControl(e)},setSideNavigation:function(e){e.placeAt(W.SideNavigation,"only");this.addDanglingControl(e)},setShellShapes:function(e){if(e.placeAt){e.placeAt(W.ShellShapes,"only");this.addDanglingControl(e)}else if(e instanceof Node){document.getElementById(W.ShellShapes).appendChild(e)}},setFooter:function(e){if(typeof e!=="object"||!e.getId){throw new Error("oFooter value is invalid")}const n=this.getFooterId();if(n){t.warning(`You can only set one footer. Replacing existing footer "${n}", with the new footer "${e.getId()}".`)}D.updateAllBaseStates("footer.content",j.Set,e.getId());e.placeAt(W.Footer,"only");this.addDanglingControl(e);if(e._applyContextClassFor){e._applyContextClassFor("footer")}},getFooterId:function(){return F.getModel().getProperty("/footer/content")},removeFooter:function(){const e=this.getFooterId();if(e){const t=s.getElementById(e);if(t&&t.destroy){t.destroy()}}D.updateAllBaseStates("footer.content",j.Set,"")},addUserPreferencesEntry:function(e,t){this._validateUserPrefEntryConfiguration(e,t);return this._updateUserPrefModel(e,t)},_validateUserPrefEntryConfiguration:function(e,t){if(!e||typeof e!=="object"){throw new Error("object oConfig was not provided")}if(!e.title){throw new Error("title was not provided")}if(!e.value){throw new Error("value was not provided")}if(typeof e.entryHelpID!=="undefined"){if(typeof e.entryHelpID!=="string"){throw new Error("entryHelpID type is invalid")}else if(e.entryHelpID===""){throw new Error("entryHelpID should not be an empty string")}}if(e.title&&typeof e.title!=="string"){throw new Error("title type is invalid")}if(typeof e.value!=="function"&&typeof e.value!=="string"&&typeof e.value!=="number"){throw new Error("value type is invalid")}["onSave","content","onCancel"].forEach(t=>{if(e[t]&&typeof e[t]!=="function"){throw new Error(`"${t}" type is "${typeof e[t]}" but should be a function`)}});if(t){[{name:"groupingId",type:"string"},{name:"groupingTabTitle",type:"string"},{name:"groupingTabHelpId",type:"string"}].forEach(t=>{if(!e[t.name]){throw new Error(`${t.name} is missing`)}else if(typeof e[t.name]!==t.type){throw new Error(`"${t.name}" type is "${typeof e[t.name]}" but should be a "${t.type}"`)}})}},_createSessionHandler:function(e){const t=2e4;sap.ui.require(["sap/ushell/SessionHandler"],n=>{this.oSessionHandler=new n;this.oSessionHandler.initLogout();window.setTimeout(()=>{this.oSessionHandler.init({sessionTimeoutReminderInMinutes:e.sessionTimeoutReminderInMinutes,sessionTimeoutIntervalInMinutes:e.sessionTimeoutIntervalInMinutes,sessionTimeoutTileStopRefreshIntervalInMinutes:e.sessionTimeoutTileStopRefreshIntervalInMinutes,enableAutomaticSignout:e.enableAutomaticSignout})},t)})},_getSessionHandler:function(){return this.oSessionHandler},_navBack:async function(){this.setUserActionsMenuSelected(false);M.navigateBack()},_updateUserPrefModel:function(e,t){const n=this._getModelEntryFromEntryObject(e);let i=S.last("/core/userPreferences/entries")||[];if(t){n.groupingEnablement=true;n.groupingId=e.groupingId;n.groupingTabTitle=e.groupingTabTitle;n.groupingTabHelpId=e.groupingTabHelpId}i.push(n);i=this._reorderUserPrefEntries(i);S.emit("/core/userPreferences/entries",i);return n.id},_getModelEntryFromEntryObject:function(e){return{id:N._getUid(),entryHelpID:e.entryHelpID,title:e.title,valueArgument:e.value,valueResult:null,onSave:e.onSave,onCancel:e.onCancel,contentFunc:e.content,contentResult:null,icon:e.icon,provideEmptyWrapper:e.provideEmptyWrapper}},_reorderUserPrefEntries:function(e){const t=[];const n=["userAccountEntry","themes","language","notificationsEntry","homepageEntry","spacesEntry","userActivitiesEntry","userDefaultEntry"];const i={};for(let t=e.length-1;t>=0;t--){if(n.indexOf(e[t].id)!==-1){const n=e.splice(t,1)[0];i[n.id]=n}}n.forEach(e=>{const n=i[e];if(n){t.push(n)}});return t.concat(e)},_getConfig:function(){return ee||{}},_getPersData:async function(e){const t=a.getOwnerComponentFor(this.getView());const n=await P.getServiceAsync("PersonalizationV2");const i={keyCategory:n.KeyCategory.FIXED_KEY,writeFrequency:n.WriteFrequency.LOW,clientStorageAllowed:true};const s=await n.getPersonalizer(e,i,t);return s.getPersData()},_getCurrentLocationHash:function(){return window.location.hash},setUserActionsMenuSelected:function(e){w.emit("showUserActionsMenu",e)},setNotificationsSelected:function(e){w.emit("showNotifications",e)},_isFLPIntent:function(e){const t=H.constructBasicHash(e);const n=["Shell-home","Shell-appfinder","Launchpad-openFLPPage","Launchpad-openWorkPage"];return n.some(e=>t===e)},_usesNavigationRedirect:async function(e){if(!e){return false}const n=e.getInstance({});if(!n){return false}if(typeof n.navigationRedirect!=="function"){return false}const i=n.navigationRedirect();if(!i||typeof i.then!=="function"){return false}try{const e=await N.promisify(i);t.warning(`Performing navigation redirect to hash "${e}"`);n.destroy();this.history.pop();const a=await P.getServiceAsync("ShellNavigationInternal");a.toExternal({target:{shellHash:e}},undefined,false);return true}catch{return false}},_adaptIsUrlSupportedResultForMessagePopover:async function(e){const t=await P.getServiceAsync("Navigation");try{await t.isUrlSupported(e.url);e.promise.resolve({allowed:true,id:e.id})}catch{e.promise.resolve({allowed:false,id:e.id})}},_initializeMessagePopover:async function(e){const[t]=await N.requireAsync(["sap/m/MessagePopover"]);if(t?.setDefaultHandlers){t.setDefaultHandlers({asyncURLHandler:this._adaptIsUrlSupportedResultForMessagePopover})}w.emit("StepDone",e.stepName)}})});
//# sourceMappingURL=Shell.controller.js.map