// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/isEmptyObject","sap/ui/core/routing/HashChanger","sap/ui/performance/trace/Interaction","sap/ui/thirdparty/hasher","sap/ui/thirdparty/jquery","sap/ushell/Container","sap/ushell/navigation/NavigationState","sap/ushell/utils/UrlShortening","sap/ushell/utils/UrlParsing"],(e,t,n,a,i,jQuery,s,r,o,h)=>{"use strict";const l={HASH_SET:{name:"hashSet",historyEntry:true},HASH_REPLACED:{name:"hashReplaced",historyEntry:false},SHELL_HASH_CHANGED:{name:"shellHashChanged",historyEntry:true,usedByUi5HistoryDetection:true,ui5EventParameterNames:{oldHash:"oldAppSpecificRouteNoSeparator",newHash:"newAppSpecificRouteNoSeparator"},updateHashOnly:true},SHELL_HASH_PARAMETER_CHANGED:{name:"shellHashParameterChanged",historyEntry:null},HASH_CHANGED:{name:"hashChanged",historyEntry:false,usedByUi5HistoryDetection:true,ui5EventParameterNames:{newHash:"newHash",fullHash:"fullHash"}}};const p="ShellNavigationHashChanger";const c="[FesrFlp]";const u=n.extend("sap.ushell.services.ShellNavigationHashChanger",{constructor:function(e){this.oServiceConfig=e;this._oNavigationState={};n.apply(this);this._initializedByShellNav=false;this._bReloadApplication=false;this._fnShellCallback=null;this._appHashPrefix="&/";this._hashPrefix="#";this.aNavigationFilters=[];this.NavigationFilterStatus={Continue:"Continue",Custom:"Custom",Abandon:"Abandon",Keep:"Keep"};this.getRelevantEventsInfo=function(){return this._getAllEvents().filter(e=>e.usedByUi5HistoryDetection).map(e=>{const t={name:e.name,paramMapping:e.ui5EventParameterNames};if(e.updateHashOnly!==undefined){t.updateHashOnly=e.updateHashOnly}return t})}}});u.prototype._getCurrentShellHash=function(){const e=this._splitHash(i.getHash());return`#${e?.shellPart||""}`};u.prototype._constructHash=function(e){const t=this._getCurrentShellHash();return`${t}${e}`};u.prototype._splitHash=function(e){if(e===undefined||e===null||e===""){return{shellPart:null,appSpecificRoute:null,intent:null,params:null}}const n=h.parseShellHash(e);if(n===undefined||n===null){return null}const a=n.params&&!t(n.params)?n.params:null;const i=n.appSpecificRoute;n.appSpecificRoute=undefined;return{shellPart:h.stripLeadingHash(h.constructShellHash(n))||null,appSpecificRoute:i||null,intent:n.semanticObject&&n.action&&`${n.semanticObject}-${n.action}${n.contextRaw||""}`||null,params:a}};u.prototype._setHash=function(e,t,n){i.prependHash="";e=h.stripLeadingHash(e);t=t||"";if(n===undefined){n=true}if(n){this.fireEvent(l.HASH_SET.name,{sHash:t});i.setHash(e)}else{this.fireEvent(l.HASH_REPLACED.name,{sHash:t});i.replaceHash(e)}};u.prototype.registerNavigationFilter=function(e){if(typeof e!=="function"){throw new Error("fnFilter must be a function")}this.aNavigationFilters.push(e)};u.prototype.unregisterNavigationFilter=function(e){if(typeof e!=="function"){throw new Error("fnFilter must be a function")}this.aNavigationFilters=this.aNavigationFilters.filter(t=>t!==e)};function f(e,t,n){this.oAppState=undefined;this.oPromise=(new jQuery.Deferred).resolve();this.getNextKey=function(){this.oAppState=e.createEmptyAppState(t,n);return this.oAppState.getKey()};this.store=function(e){this.oAppState.setData(e);const t=this.oAppState.save();this.oPromise=jQuery.when(this.oPromise,t)};this.getPromise=function(){return this.oPromise}}u.prototype.compactParams=function(e,t,n,a){const i=new jQuery.Deferred;const r=h.constructShellHash({target:{semanticObject:"SO",action:"action"},params:e});if(e===undefined||Object.keys(e).length===0){return i.resolve(e).promise()}s.getServiceAsync("AppState").then(e=>{const s=new f(e,n,a);const l=o.compactHash(r,t,s);const p=h.parseParameters(l.hash.match(/\?.*/)[0]);s.getPromise().done(()=>{i.resolve(p)}).fail(i.reject)});return i.promise()};u.prototype.hrefForExternal=async function(e,t){let n=await this.hrefForExternalNoEncAsync(e,t);if(t){n.hash=encodeURI(n.hash)}else{n=encodeURI(n)}return n};u.prototype.hrefForExternalSync=function(e,t,n){let a=this.hrefForExternalNoEnc(e,t,n);if(t){a.hash=encodeURI(a.hash)}else{a=encodeURI(a)}return a};u.prototype.hrefForExternalNoEnc=function(t,n,a,i){e.error("Deprecated API call of 'sap.ushell.services.ShellNavigationHashChanger.hrefForExternalNoEnc'. Please use 'hrefForExternalNoEncAsync' instead",null,"sap.ushell.services.ShellNavigationHashChanger");if(i){const e=new jQuery.Deferred;this.hrefForExternalNoEncAsync(t,n).then(e.resolve).catch(e.reject);return e.promise()}const s=this._hrefForExternalNoEnc(t);if(n){return{hash:s,params:undefined,skippedParams:undefined}}return s};u.prototype.hrefForExternalNoEncAsync=async function(e,t){let n;const a=this._hrefForExternalNoEnc(e);if(t){n={hash:a,params:undefined,skippedParams:undefined}}else{n=a}return n};u.prototype._hrefForExternalNoEnc=function(e){if(e===undefined){return this._getCurrentShellHash()}if(e&&e.target&&(typeof e.target.semanticObject==="string"||typeof e.target.shellHash==="string")){return`#${h.constructShellHash(e)}`}return this._getCurrentShellHash()};u.prototype._getAppHash=function(e){let t;if(e&&e.target&&typeof e.target.shellHash==="string"){const n=h.parseShellHash(e.target.shellHash);t=n&&n.appSpecificRoute;t=t&&t.substring(2)}return t};u.prototype.hrefForAppSpecificHash=function(e){return encodeURI(this._constructHash(this._appHashPrefix+e))};u.prototype.toExternal=function(e,t,n){const a=this._hrefForExternalNoEnc(e);const i=this._getAppHash(e);this._setHash(a,i,n);return Promise.resolve()};u.prototype.toAppHash=function(e,t){const n=this._constructHash(this._appHashPrefix+e);this._setHash(n,e,t)};u.prototype.initShellNavigation=function(t){if(this._initializedByShellNav){e.info("initShellNavigation already called on this ShellNavigationHashChanger instance.");return false}this._fnShellCallback=t;i.changed.add(this.treatHashChanged,this);if(!i.isActive()){i.initialized.addOnce(this.treatHashChanged,this);i.init()}else{this.treatHashChanged(i.getHash())}this._initializedByShellNav=true;return true};u.prototype.init=function(){if(this._initialized){e.info("init already called on this ShellNavigationHashChanger instance.");return false}const t=this._splitHash(i.getHash());const n=(t?.appSpecificRoute||"  ").substring(2);const a=n?"&/":"";const s=t?.shellPart||"";this.fireEvent(l.HASH_CHANGED.name,{newHash:n,fullHash:s+a+n});this._initialized=true;return true};u.prototype._removeInnerAppSeparator=function(e){return(e||"").replace("&/","")};u.prototype._startFesrInteraction=function(){if(!this._fnResolveFesrInteraction){e.debug(`${c} Interaction Start`,null,p);this._fnResolveFesrInteraction=a.notifyAsyncStep()}};u.prototype._endFesrInteraction=function(){if(this._fnResolveFesrInteraction){e.debug(`${c} Interaction End`,null,p);this._fnResolveFesrInteraction();this._fnResolveFesrInteraction=null}};u.prototype._trackNavigation=function(e,t){this._oNavigationState.newHash=e;this._oNavigationState.oldHash=t};u.prototype.getCurrentNavigationState=function(){return this._oNavigationState};u.prototype.treatHashChanged=function(t,n){r.startNavigation();this._trackNavigation(t,n);this._startFesrInteraction();if(this.inAbandonFlow){this._endFesrInteraction();this.setReloadApplication(false);r.endNavigation();return}let a;t=o.expandHash(t);n=o.expandHash(n);const s=this._splitHash(t);let p=this._splitHash(n);if(!s){const e=new Error(`Illegal new hash - cannot be parsed: '${t}'`);this.fireEvent(l.SHELL_HASH_CHANGED.name,{newShellHash:t,newAppSpecificRoute:null,fullHash:t,oldShellHash:p?p.shellPart:n,error:e});this._fnShellCallback(t,null,p?p.shellPart:n,p?p.appSpecificRoute:null,e);this._endFesrInteraction();this.setReloadApplication(false);return}if(!p){p={shellPart:n,appSpecificRoute:null}}for(let s=0;s<this.aNavigationFilters.length;s++){try{let e;const r=this.aNavigationFilters[s].call(undefined,t,n);let o=r;if(typeof r!=="string"){o=r.status;e=r.hash}if(o===this.NavigationFilterStatus.Custom){if(e&&e.length>0){this.inAbandonFlow=true;i.replaceHash(e);this.inAbandonFlow=false}this._endFesrInteraction();this.setReloadApplication(false);return}if(o===this.NavigationFilterStatus.Abandon){this.inAbandonFlow=true;i.replaceHash(n);this.inAbandonFlow=false;this._endFesrInteraction();this.setReloadApplication(false);return}if(o===this.NavigationFilterStatus.Keep){a=true}}catch(t){e.error("Error while calling Navigation filter! ignoring filter...",t,"sap.ushell.services.ShellNavigationHashChanger")}}if(a){this.fireEvent(l.HASH_CHANGED.name,{newHash:t,oldHash:n,fullHash:t});this._endFesrInteraction();this.setReloadApplication(false);r.endNavigation();return}const c=n===undefined;const u=h.compareHashes(t,n);u.sameIntent=u.sameIntent&&!c;const f=u.sameIntent&&u.sameParameters&&u.sameAppSpecificRoute;if(f){e.info("Navigation happened but hash stayed the same",null,"sap.ushell.services.ShellNavigationHashChanger");this.fireEvent(l.HASH_CHANGED.name,{newHash:this._removeInnerAppSeparator(s.appSpecificRoute),oldHash:this._removeInnerAppSeparator(p.appSpecificRoute),fullHash:t});this._endFesrInteraction();this.setReloadApplication(false);return}const H=u.sameIntent&&u.sameParameters;if(H){if(this.getReloadApplication()){this.setReloadApplication(false)}else{const n=this._removeInnerAppSeparator(s.appSpecificRoute);const a=this._removeInnerAppSeparator(p.appSpecificRoute);e.info(`Inner App Hash changed from '${a}' to '${n}'`,null,"sap.ushell.services.ShellNavigationHashChanger");this.fireEvent(l.HASH_CHANGED.name,{newHash:n,oldHash:a,fullHash:t});this._endFesrInteraction();r.endNavigation();return}}if(u.sameIntent&&this.hasListeners(l.SHELL_HASH_PARAMETER_CHANGED.name)){const t=h.paramsToString(s.params);const n=h.paramsToString(p.params);e.info(`Shell hash parameters changed from '${n}' to '${t}'`,null,"sap.ushell.services.ShellNavigationHashChanger");this.fireEvent(l.SHELL_HASH_PARAMETER_CHANGED.name,{oNewParameters:s.params,oOldParameters:p.params});this._endFesrInteraction();this.setReloadApplication(false);r.endNavigation();return}e.info(`Outer shell hash changed from '${n}' to '${t}'`,null,"sap.ushell.services.ShellNavigationHashChanger");this.fireEvent(l.SHELL_HASH_CHANGED.name,{newShellHash:s.shellPart,newAppSpecificRoute:s.appSpecificRoute,fullHash:t,oldShellHash:p.shellPart,oldAppSpecificRoute:p.appSpecificRoute,error:"",oldAppSpecificRouteNoSeparator:this._removeInnerAppSeparator(p.appSpecificRoute),newAppSpecificRouteNoSeparator:this._removeInnerAppSeparator(s.appSpecificRoute)});this._fnShellCallback(s.shellPart,s.appSpecificRoute,p.shellPart,p.appSpecificRoute);this._endFesrInteraction();this.setReloadApplication(false)};u.prototype.setHash=function(e){this.toAppHash(e,true)};u.prototype.replaceHash=function(e){this.toAppHash(e,false)};u.prototype.getHash=function(){return this.getAppHash()};u.prototype.getAppHash=function(){const e=this._splitHash(i.getHash());const t=(e?.appSpecificRoute||"  ").substring(2);return t};u.prototype.destroy=function(){i.changed.remove(this.treatHashChanged,this);n.prototype.destroy.apply(this,arguments)};u.prototype._getAllEvents=function(){return Object.keys(l).map(e=>l[e])};u.prototype.getReplaceHashEvents=function(){return this._getAllEvents().filter(e=>e.historyEntry===false).map(e=>e.name)};u.prototype.getSetHashEvents=function(){return this._getAllEvents().filter(e=>e.historyEntry===true).map(e=>e.name)};u.prototype.isInnerAppNavigation=function(e,t){const n=h.parseShellHash(e);const a=h.parseShellHash(t);const i=t===undefined;const s=h.haveSameIntent(n,a)&&!i;const r=h.haveSameIntentParameters(n,a);return s&&r};u.prototype.getReloadApplication=function(){return this._bReloadApplication};u.prototype.setReloadApplication=function(e){this._bReloadApplication=e};return u});
//# sourceMappingURL=ShellNavigationHashChanger.js.map