// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/Deferred","sap/base/util/isPlainObject","sap/base/util/ObjectPath","sap/base/util/uid"],(e,s,t,i,r)=>{"use strict";const n={provideApplicationContext:false,allowInactive:false};const a={preventBroadcast:false,onlyCurrentApplication:false,ignoreCapabilities:false};const o=Symbol("DoNotReply");const l=e.getLogger("sap.ushell.appIntegration.PostMessageManager");class c{#e=()=>{throw new Error("PostMessageManager is not initialized")};#s=()=>{throw new Error("PostMessageManager is not initialized")};#t=()=>{throw new Error("PostMessageManager is not initialized")};#i=false;#r=false;#n=false;#a=[];#o=[];#l={};#c={};#d=true;#u=[];BuiltInResponses={DoNotReply:o};init(e={}){if(this.#i){throw new Error("PostMessageManager is already initialized.")}const s=i.get("sap-ushell-config.services.PostMessage.config")||{};if(s.enabled===false){this.#r=true;this.#i=true;l.warning("PostMessageAPI is disabled by configuration.");return}const t=e.getCurrentApplication||function(){};const r=e.getAllApplications||function(){const e=t();return e?[e]:[]};this.#s=t;this.#t=r;if(e.skipReplay){this.#d=false}if(e.skipSourceValidation){this.#n=true}this.#e=this.#p.bind(this);addEventListener("message",this.#e);this.#i=true}async#p(e){let s;try{s=this.#g(e)}catch{l.debug("Received Post Message with invalid JSON. Ignoring the message.",e.data);return}const t=this.#h(e,s);e=t.event;s=t.message;if(!s.service){l.debug("Received Post Message without a service name. Ignoring the message.");return}if(!["response","request"].includes(s.type)){l.warning(`Received Post Message with an invalid type: '${s.type}'. Ignoring the message.`);return}const i=e.source;const r=e.origin;l.debug(`Received postMessage ${s.service} (${s.request_id}) from iframe with domain '${r}'`,JSON.stringify(s,null,2));if(!s.request_id){l.debug("Received Post Message without a request_id. Message might be not handled correctly.")}if(s.type==="response"){const t=this.#f(e,s);if(t){l.debug(`Response for ${s.service} (${s.request_id}) was handled by a response handler.`)}return}s.body=s.body||{};let n;let a=true;try{const t=await this.#b(s,i,r,e);l.debug(`Service request for ${s.service} (${s.request_id}) was handled successfully.`);if(t===o){l.debug(`Service request for ${s.service} (${s.request_id}) was handled successfully, but no response is needed.`);return}n={result:t}}catch(e){a=false;l.error(`Service request for ${s.service} (${s.request_id}) failed.`,e);let t;let i=e.toString();if(e instanceof Error){i=e.message;t=e.stack}n={message:i,stack:t}}const c=s.originalMessage?.service||s.service;return this.sendResponse(s.request_id,c,n,a,i,r)}#g(e){let s;if(typeof e.data==="string"){s=JSON.parse(e.data)}else if(t(e.data)){s=e.data}else{throw new Error("Invalid message format")}return s}getRequestId(e){try{const s=this.#g(e);return s.request_id}catch{}}#h(e,s){let t;this.#a.forEach(i=>{if(t){return}t=i(e,s)});return{event:t?.event||e,message:t?.message||s}}#f(e,s){let t=false;this.#o.forEach(i=>{if(t){return}t=i(e,s)});return t}async#b(e,s,t,i){const r=e.service;const n=this.#v(r);if(!n){if(this.#d){this.#u.push(i);return o}await this.sendResponse(e.request_id,r,{code:-1,message:`Unknown service name: '${r}'`},false,s,t);return o}await this.#w(i,r);const a=this.#M(r);if(a.provideApplicationContext){const t=this.#P(s);if(!t){throw new Error("Cannot find the related application for the service request.")}l.debug(`Handling service request for ${r} (${e.request_id}) with application context ${t.getId()}.`);return n(e.body,t,i)}l.debug(`Handling service request for ${r} (${e.request_id}) without application context.`);return n(e.body,i)}async#w(e,s){if(this.#n){return}const t=this.#M(s);const i=typeof t.isValidRequest==="function";if(i){const i=await t.isValidRequest(e);if(!i){throw new Error(`Invalid request for service ${s}.`)}}else{const s=this.#P(e.source);if(!s){throw new Error("Cannot find the related application for the service request.")}if(!s.getActive()&&!t.allowInactive){throw new Error("Received Post Message from an inactive application.")}if(!s.isTrustedPostMessageSource(e)){throw new Error("Received Post Message from an untrusted source.")}}}#v(e){return this.#l[e]?.handler}#M(e){return this.#l[e]?.options}#P(e){let s;this.#t().forEach(t=>{if(s||!t.isA("sap.ushell.appIntegration.IframeApplicationContainer")){return}const i=t.getPostMessageTarget();if(i===e){s=t}});if(s){return s}l.error("Cannot find the related application for the service request; using the current application as fallback. This fallback will be removed in future");const t=this.#s();if(t&&t.isA("sap.ushell.appIntegration.IframeApplicationContainer")){return t}}addEventPreprocessor(e){this.#a.push(e)}setRequestHandler(e,s,t={}){if(this.#l[e]){l.error(`Request handler for service ${e} is already defined. Overwriting the existing handler.`)}this.#l[e]={handler:s,options:{...n,...t}}}async sendRequest(e,s,t,i,n){if(this.#r){throw new Error("PostMessageAPI is disabled by configuration.")}if(!this.#i){throw new Error("PostMessageManager is not initialized.")}const a=r();const o={type:"request",request_id:a,service:e,body:s||{}};return this.#q(o,t,i,n)}async sendResponse(e,s,t,i,r,n){if(this.#r){throw new Error("PostMessageAPI is disabled by configuration.")}if(!this.#i){throw new Error("PostMessageManager is not initialized.")}const a={type:"response",request_id:e,service:s,status:i?"success":"error",body:t||{}};return this.#q(a,r,n,false)}async#q(e,s,t,i){if(!s){throw new Error("No content window provided.")}const r=e.request_id;let n=Promise.resolve();if(i){l.debug(`Waiting for response on ${e.service} (${e.request_id}) from iframe with domain '${t}'`);n=this.#y(r,s)}const a=JSON.stringify(e);l.debug(`Sending post message on ${e.service} (${e.request_id}) to iframe with domain '${t}'`,JSON.stringify(e,null,2));s.postMessage(a,t);return n}#y(e,t){const i=new s;const r=this.#R.bind(this,i,e,t);this.#o.push(r);return i.promise}#R(e,s,t,i,r){if(t!==i.source){return false}if(r?.request_id!==s){return false}l.debug(`Received response for ${r.service} (${r.request_id}) from iframe with domain '${i.origin}'`);if(r.status==="success"){e.resolve(r.body)}else{let s;if(r.body?.message){s=new Error(r.body.message)}else{s=new Error("Unknown error")}if(r.body?.stack){s.stack=r.body.stack}e.reject(s)}return true}async sendRequestToApplication(e,s,t,i){if(this.#r){throw new Error("PostMessageAPI is disabled by configuration.")}if(!this.#i){throw new Error("PostMessageManager is not initialized.")}const r=this.#E(e);if(r.onlyCurrentApplication){const e=this.#s();if(t!==e){throw new Error("Application is not the current application.")}}const n=r.ignoreCapabilities||t.supportsCapabilities([e]);if(!n){throw new Error(`Application does not support the service request: ${e}`)}if(typeof r?.isValidRequestTarget==="function"){const e=r.isValidRequestTarget(t);if(!e){throw new Error("Application is not a valid request target.")}}return this.sendRequest(e,s,t.getPostMessageTarget(),t.getPostMessageTargetOrigin(),i)}async sendRequestToAllApplications(e,s,t){if(this.#r){throw new Error("PostMessageAPI is disabled by configuration.")}if(!this.#i){throw new Error("PostMessageManager is not initialized.")}const i=this.#E(e);if(i.preventBroadcast){throw new Error(`Cannot send request to all applications for service request: ${e}. The distribution policy prevents broadcasting.`)}const r=[];if(i.onlyCurrentApplication){const e=this.#s();if(!e){return[]}r.push(e)}else{this.#t().forEach(e=>{r.push(e)})}const n=r.filter(s=>{if(!s.isA("sap.ushell.appIntegration.IframeApplicationContainer")){return false}const t=i.ignoreCapabilities||s.supportsCapabilities([e]);if(!t){return false}if(typeof i?.isValidRequestTarget==="function"){const e=i.isValidRequestTarget(s);return e}return true});const a=n.map(i=>this.sendRequest(e,s,i.getPostMessageTarget(),i.getPostMessageTargetOrigin(),t));return Promise.allSettled(a).then(e=>{const s=e.filter(e=>e.status==="rejected").map(e=>e.reason);if(s.length>0){throw new Error(`Some requests failed: ${s.map(e=>e.message).join(", ")}`)}return e.map(e=>e.value)})}#E(e){return this.#c[e]||a}setDistributionPolicy(e,s){if(this.#c[e]){l.error(`Distribution policy for service ${e} is already defined. Overwriting the existing policy.`)}this.#c[e]={...a,...s}}replayStoredMessages(){this.#d=false;this.#u.forEach(e=>{this.#p(e)});this.#u=[]}reset(){removeEventListener("message",this.#e);this.#e=()=>{throw new Error("PostMessageManager is not initialized")};this.#s=()=>{throw new Error("PostMessageManager is not initialized")};this.#t=()=>{throw new Error("PostMessageManager is not initialized")};this.#i=false;this.#r=false;this.#n=false;this.#a=[];this.#l={};this.#o=[];this.#c={};this.#d=true;this.#u=[]}}return new c});
//# sourceMappingURL=PostMessageManager.js.map