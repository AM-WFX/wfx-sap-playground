// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/uid","sap/ui/Device","sap/ui/thirdparty/URI","sap/ushell/appIntegration/ApplicationContainer","sap/ushell/appIntegration/IframeApplicationContainerRenderer","sap/ushell/appIntegration/PostMessageManager","sap/ushell/ApplicationType/UrlPostProcessing","sap/ushell/ApplicationType/systemAlias","sap/ushell/Config","sap/ushell/Container","sap/ushell/library","sap/ushell/System","sap/ushell/utils","sap/ushell/utils/UriParameters"],(e,t,i,s,r,n,a,o,p,l,g,u,c,h,f)=>{"use strict";const d=3500;const y=r.extend("sap.ushell.appIntegration.IframeApplicationContainer",{metadata:{library:"sap.ushell",properties:{visible:{type:"boolean",defaultValue:true},nwbcDirtyStorageKey:{defaultValue:"",type:"string"},iframeUrl:{defaultValue:"",type:"string",visibility:"hidden"},iframePostAllParams:{defaultValue:false,type:"boolean"},iframeWithPost:{defaultValue:false,type:"boolean"},iframeIsValidSupport:{defaultValue:false,type:"boolean"},lastIframeIsValidTime:{defaultValue:0,type:"int"},preparingRendering:{defaultValue:false,type:"boolean",visibility:"hidden"},renderingPrepared:{defaultValue:false,type:"boolean",visibility:"hidden"}},interfaces:["sap.ushell.renderer.INavContainerPage"]},renderer:n});y.prototype.init=function(){r.prototype.init.apply(this,arguments);this._aPendingRequestsWaitingForResponse=[];this.setProperty("lastIframeIsValidTime",Date.now(),true);const e=`sap.ushell.Container.dirtyState.${t()}`;this.setProperty("nwbcDirtyStorageKey",e,true);localStorage.removeItem(this.getNwbcDirtyStorageKey());this._fnStorageEventListener=this._handleNwbcStorageEvent.bind(this);addEventListener("storage",this._fnStorageEventListener);this._fnPagehideEventListener=this.exit.bind(this);addEventListener("pagehide",this._fnPagehideEventListener)};y.prototype.prepareRendering=async function(){if(this.getProperty("preparingRendering")||this.getProperty("renderingPrepared")){return}try{this._attachNwbcLogoutEvent();this._initNwbcDirtyState();this._addRemoteSystemForUrl();await this._calculateIframeUrl();this._calculateIframeWithPost();if(!this.getProperty("iframeWithPost")){const e=this.getProperty("iframeUrl");const t=p.addSystemAlias(e,this);this.setProperty("iframeUrl",t,true)}}catch(t){e.error("Error during prepareRendering:",t,"sap.ushell.appIntegration.IframeApplicationContainer")}this.setProperty("preparingRendering",false,true);this.setProperty("renderingPrepared",true)};y.prototype.onBeforeRendering=function(){if(!this.getReadyForRendering()){return}this.prepareRendering()};y.prototype.onAfterRendering=async function(){if(!this.getReadyForRendering()||this.getProperty("preparingRendering")||!this.getProperty("renderingPrepared")){return}const e=await g.getServiceAsync("MessageBroker");const t=this.getPostMessageTargetOrigin();e.addAcceptedOrigin(t);const s=this.getDomRef();if(i.os.ios&&s?.tagName==="IFRAME"){s.parentNode.style.overflow="auto"}};y.prototype.setVisibility=function(e){this.setProperty("visible",e,true);const t=this.getDomRef();if(t){t.setAttribute("aria-hidden",!e)}if(e){this.removeStyleClass("sapUShellApplicationContainerIframeHidden");this.removeStyleClass("sapUShellApplicationContainerIframeHiddenButActive");return}if(this._aPendingRequestsWaitingForResponse.length>0){this.addStyleClass("sapUShellApplicationContainerIframeHiddenButActive")}else{this.addStyleClass("sapUShellApplicationContainerIframeHidden")}};y.prototype.setDataHelpId=function(e){r.prototype.setDataHelpId.apply(this,arguments);if(!this.getDomRef()||!this.getIframeWithPost()){return this}const t=this._getIframe();if(t){t.setAttribute("data-help-id",`${e}-iframe`)}return this};y.prototype._attachNwbcLogoutEvent=function(){const e=this.getApplicationType();if(h.isApplicationTypeEmbeddedInIframe(e)){this._fnLogout=this._handleNwbcLogout.bind(this);g.attachLogoutEvent(this._fnLogout)}};y.prototype._initNwbcDirtyState=function(){const e=this.getApplicationType();const t=this.getFrameworkId();if(h.isApplicationTypeEmbeddedInIframe(e,true)||h.isApplicationTypeEmbeddedInIframe(t)){h.localStorageSetItem(this.getNwbcDirtyStorageKey(),g.DirtyState.INITIAL)}};y.prototype._getDocumentUrl=function(){return document.URL};y.prototype._calculateIframeWithPost=function(){const e=f.fromURL(this._getDocumentUrl());const t=this.getApplicationType();const i=l.last("/core/shell/enableOpenIframeWithPost")??true;const s=e.get("sap-post")==="false";const r=e.get("sap-post")==="true";const n=this.getOpenWithPostByAppParam()===false;const a=["NWBC","TR","WDA","WCF"].includes(t);let o;if(r){o=true}else if(s){o=false}else if(n){o=false}else{o=i&&a}if(o&&t==="TR"){this.setProperty("iframePostAllParams",true,true)}this.setProperty("iframeWithPost",o,true)};y.prototype._calculateIframeUrl=async function(){const e=this.getApplicationType();let t=this.getUrl();t=await o.processUrl(t,e,false,this);t=this._injectParametersFromDocumentUrl(t);this.setProperty("iframeUrl",t,true)};y.prototype._injectParametersFromDocumentUrl=function(e){const t=f.fromURL(this._getDocumentUrl());if(!t.has("sap-iframe-params")){return e}const i=t.get("sap-iframe-params")||"";const r=i.split(",");const n=new s(e);r.forEach(e=>{if(e&&t.has(e)){n.addQuery(e,t.get(e))}});e=n.toString();return e};y.prototype._addRemoteSystemForUrl=function(){if(this._oSystem){return}const e=this.getUrl();const t=document.createElement("a");const i=f.fromURL(e).get("sap-client");t.href=e;const s=`${t.protocol}//${t.host}`;this._oSystem=new c({alias:i?`${s}?sap-client=${i}`:s,baseUrl:s,client:i||undefined,platform:"abap"});g.addRemoteSystem(this._oSystem)};y.prototype._handleNwbcStorageEvent=function(t){if(t.key!==this.getNwbcDirtyStorageKey()){return}if(t.newValue!==g.DirtyState.PENDING){return}const i=this.getPostMessageTarget();if(!i){return}e.debug("getGlobalDirty() send pro54_getGlobalDirty ",null,"sap.ushell.appIntegration.ApplicationContainer");const s=this.getPostMessageTargetOrigin();const r=JSON.stringify({action:"pro54_getGlobalDirty"});i.postMessage(r,s)};y.prototype._handleNwbcLogout=function(e){const t=this.getPostMessageTarget();const i=this.getApplicationType();if(t&&h.isApplicationTypeEmbeddedInIframe(i)){const i=this.getPostMessageTargetOrigin();t.postMessage(JSON.stringify({action:"pro54_disableDirtyHandler"}),i);e.preventDefault()}};y.prototype._getIframe=function(){const e=this.getDomRef();if(!e||e.tagName!=="IFRAME"){if(this.getIframeWithPost()===true&&e&&e.getAttribute&&e.getAttribute("data-sap-ushell-iframe-app")==="true"){return document.getElementById(`${e.getAttribute("id")}-iframe`)}return null}return e};y.prototype.getPostMessageTarget=function(){const e=this._getIframe();return e?.contentWindow};y.prototype.getPostMessageTargetOrigin=function(){let e;const t=this._getIframe();if(!t){return""}if(this.getIframeWithPost()===true){const i=`${t.getAttribute("id").replace("-iframe","-form")}`;const s=document.getElementById(i);e=s?.action}else{e=t.src}const i=new s(e);const r=`${i.protocol()}://${i.host()}`;return r};y.prototype.isTrustedPostMessageSource=function(e){if(!e){return false}if(e.source&&e.source===this.getPostMessageTarget()){return true}if(e.origin&&e.origin===this.getPostMessageTargetOrigin()){return true}return false};y.prototype.sendRequest=async function(e,t,i=false){if(!i){return a.sendRequestToApplication(e,t,this,false)}if(!this.getProperty("visible")){this.addStyleClass("sapUShellApplicationContainerIframeHiddenButActive");this.removeStyleClass("sapUShellApplicationContainerIframeHidden")}const s=a.sendRequestToApplication(e,t,this,true);this._aPendingRequestsWaitingForResponse.push(s);const r=await s;this._aPendingRequestsWaitingForResponse=this._aPendingRequestsWaitingForResponse.filter(e=>e!==s);if(this._aPendingRequestsWaitingForResponse.length===0&&!this.getProperty("visible")){this.addStyleClass("sapUShellApplicationContainerIframeHidden");this.removeStyleClass("sapUShellApplicationContainerIframeHiddenButActive")}return r};y.prototype.sendBeforeAppCloseEvent=async function(){const e=this.getBeforeAppCloseEvent();if(e?.enabled===true){return this.sendRequest("sap.ushell.services.CrossApplicationNavigation.beforeAppCloseEvent",e.params,true)}};y.prototype.isValid=function(){if(!this.getIframeIsValidSupport()){return true}const e=Date.now()-this.getLastIframeIsValidTime();const t=e>=d;const i=`iframe did not ping in the last '${e}' ms`;if(t){throw new Error(i)}return true};y.prototype.exit=function(){localStorage.removeItem(this.getNwbcDirtyStorageKey());if(this._fnStorageEventListener){removeEventListener("storage",this._fnStorageEventListener)}if(this._fnPagehideEventListener){removeEventListener("pagehide",this._fnPagehideEventListener)}if(this._fnLogout){g.detachLogoutEvent(this._fnLogout)}r.prototype.exit.apply(this,arguments)};return y});
//# sourceMappingURL=IframeApplicationContainer.js.map